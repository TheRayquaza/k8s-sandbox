---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: cilium
  namespace: argocd
  annotations:
    argocd.argoproj.io/sync-wave: "0"
  finalizers:
    - resources-finalizer.argocd.argoproj.io
  labels:
    app: cilium
spec:
  project: default
  syncPolicy:
    syncOptions:
      - CreateNamespace=true
    automated:
      prune: true
      selfHeal: true
  destination:
    name: in-cluster
    namespace: kube-system
  sources:
    - repoURL: https://helm.cilium.io/
      chart: cilium
      targetRevision: 1.18.5
      helm:
        values: |
          # -------------------------------------------------------------------
          # Hubble Relay & UI
          # -------------------------------------------------------------------
          hubble:
            relay:
              enabled: true
            ui:
              enabled: true

          # -------------------------------------------------------------------
          # NodePort / Services
          # -------------------------------------------------------------------
          nodePort:
            enableHealthCheck: true
            enableHealthCheckLoadBalancerIP: false
            bindProtection: true
          serviceNoBackendResponse: reject

          enableInternalTrafficPolicy: true
          
          # -------------------------------------------------------------------
          # Gateway API
          # -------------------------------------------------------------------
          gatewayAPI:
            enabled: true

          # -------------------------------------------------------------------
          # Core cluster identity
          # -------------------------------------------------------------------
          cluster:
            id: 0
            name: default

          # -------------------------------------------------------------------
          # Kubernetes integration
          # -------------------------------------------------------------------
          k8s:
            requireIPv4PodCIDR: false
            requireIPv6PodCIDR: false

          # -------------------------------------------------------------------
          # kube-proxy replacement
          # -------------------------------------------------------------------
          kubeProxyReplacement: true
          # k8sServiceHost: auto
          k8sServiceHost: "10.20.0.1"
          k8sServicePort: "6443"

          # -------------------------------------------------------------------
          # IPAM
          # -------------------------------------------------------------------
          ipam:
            mode: cluster-pool
            operator:
              clusterPoolIPv4PodCIDRList: ["10.244.0.0/16"]
              clusterPoolIPv4MaskSize: 24

          ipv4NativeRoutingCIDR: 10.0.0.0/8

          # -------------------------------------------------------------------
          # Networking mode
          # -------------------------------------------------------------------
          routingMode: tunnel
          tunnelProtocol: vxlan
          autoDirectNodeRoutes: false
          directRoutingSkipUnreachable: false

          # -------------------------------------------------------------------
          # IPv4 / IPv6
          # -------------------------------------------------------------------
          enableIPv4: true
          enableIPv6: false

          enableIPv4Masquerade: true
          enableIPv6Masquerade: false

          # -------------------------------------------------------------------
          # BPF & datapath
          # -------------------------------------------------------------------
          bpf:
            root: /sys/fs/bpf
            masquerade: true
            mapDynamicSizeRatio: 0.0025
            preallocateMaps: false
            lb:
              acceleration: disabled
              mapMax: 65536
              algorithmAnnotation: false
              modeAnnotation: false
              sock: false
              externalClusterIP: false
              sourceRangeAllTypes: false

              enableBPFMasquerade: true
              enableBPFClockProbe: false

              datapathMode: veth
              enableTCX: true

          # -------------------------------------------------------------------
          # CNI
          # -------------------------------------------------------------------
          cni:
            exclusive: true
            customConf: false
            logFile: /var/run/cilium/cilium-cni.log
            writeCNIConfWhenReady: /host/etc/cni/net.d/05-cilium.conflist

          # -------------------------------------------------------------------
          # Policy
          # -------------------------------------------------------------------
          k8sNetworkPolicy:
            enabled: true
          enableNonDefaultDenyPolicies: true
          daemon:
            enableSourceIPVerification: true

          # -------------------------------------------------------------------
          # Node handling
          # -------------------------------------------------------------------
          agentNotReadyTaintKey: node.cilium.io/agent-not-ready
          synchronizeK8sNodes: true

          # -------------------------------------------------------------------
          # Masquerading & iptables
          # -------------------------------------------------------------------
          iptablesRandomFully: false
          installNoConntrackIptablesRules: false

          # -------------------------------------------------------------------
          # L7 / Envoy
          # -------------------------------------------------------------------
          l7Proxy: true

          envoy:
            baseID: 0
            accessLogBufferSize: 4096
            keepCapNetBindService: false

          # -------------------------------------------------------------------
          # DNS proxy / FQDN
          # -------------------------------------------------------------------
          dnsProxy:
            socketLingerTimeout: 10

          # -------------------------------------------------------------------
          # Identity management
          # -------------------------------------------------------------------
          identityAllocationMode: crd
          identityManagementMode: agent

          # -------------------------------------------------------------------
          # Health checking
          # -------------------------------------------------------------------
          healthCheckICMPFailureThreshold: 3

          # -------------------------------------------------------------------
          # Metrics & monitoring
          # -------------------------------------------------------------------
          monitor:
            enabled: true

          # -------------------------------------------------------------------
          # Operator
          # -------------------------------------------------------------------
          operator:
            replicas: 1
            nodeGCInterval: 5m

          # -------------------------------------------------------------------
          # SCTP / VTEP
          # -------------------------------------------------------------------
          enableSCTP: false
          enableVTEP: false

          # -------------------------------------------------------------------
          # Miscellaneous
          # -------------------------------------------------------------------
          priorityClassName: system-cluster-critical

    - repoURL: https://github.com/TheRayquaza/k8s-sandbox.git
      targetRevision: HEAD
      path: k8s/cilium
